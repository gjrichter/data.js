/** 
 * @fileoverview
 * provides an object and methods to load, parse and process various data sources.<br>
 * The <b>sources</b> may be of the following type: <b>csv</b>, <b>json</b>, <b>geojson</b>, <b>kml</b>, <b>gml</b>, <b>rss</b>, and <b>parquet</b> (using DuckDB WASM).<br>
 * The <b>methods</b> to load data are: 
 * <ul><li>Data.<b>feed()</b> to load from url</li>
 * <li>Data.<b>import()</b> to import javascript objects and</li>
 * <li>Data.<b>broker()</b> to load more than one source</li></ul>
 * The loaded data is stored in a Table object which gives the user the methods to transform the data.<br>
 * The format of the data of a Table object is jsonDB, the same format used internaly by iXmaps.
 * @example 
 *
 *  // define data source
 *  var szUrl = "https://raw.githubusercontent.com/emergenzeHack/terremotocentro/master/_data/issues.csv";
 *
 *  // load data from feed
 *  var myfeed = Data.feed({"source":szUrl,"type":"csv"}).load(function(mydata){
 *
 *      // on data load succeeds, process the loaded data via mydata object
 *      // create new columns 'date' and 'hour' from one timestamp column
 *      // we need them to create pivot tables 
 *      // ---------------------------------------------------------------
 *      mydata.addColumn({'source':'created_at','destination':'date'},function(value){
 *          var d = new Date(__normalizeTime(value));
 *          return( String(d.getDate()) + "." + String(d.getMonth()+1) + "." + String(d.getFullYear()) );
 *      });
 *
 *      // get the hours
 *      // -----------------------------------------
 *      var hoursA = mydata.column("hour").values();
 *
 *      // do something ... 
 *
 *      // make a pivot table from the values in column 'state'
 *      // ----------------------------------------------------
 *      var pivot = mydata.pivot({ "lead":	'date',
 *                                 "keep":  ['created_at'],	
 *                                 "cols":	'state' 
 *                               });
 *
 *      // invert data table (let the last record be the first)
 *      // ----------------------------------------------
 *      pivot = pivot.revert();
 *
 *      // make chart with 2 curves, total and closed issues
 *      // -------------------------------------------------
 *      var set1  = pivot.column("Total").values();
 *      var set2  = pivot.column("closed").values();
 *
 *     ....
 * }).error(function(e){
 *      alert("Data.feed error: " + e);
 * });
 *
 * @author Guenter Richter guenter.richter@medienobjekte.de
 * @version 1.55 
 * @copyright CC BY SA
 * @license MIT
 */
!function(e,t,o){new Date;_LOG=function(e){new Date};const s=function(e){return e&&void 0!==e?function(e){return"[object Array]"===Object.prototype.toString.call(e)}(e)?e:String(e).match(/\|/)?String(e).split("|"):String(e).split(","):[]},r=function(e,t,o){return o.indexOf(e)===t};var n={version:"1.55",errors:[]};"object"==typeof module&&"object"==typeof module.exports?module.exports=n:"function"==typeof define&&define.amd&&define(n),void 0!==e&&function(){const t=e.Data;n.noConflict=function(){return e.Data=t,this},e.Data=n}(),n.Object=function(e){this.options=e,this.debug=!1},n.Object.prototype={import:function(e){return this.options.success=this.options.success||e,this.feed=n.feed({}),this.feed.options=this.options,"csv"==this.options.type||"CSV"==this.options.type?this.feed.__processCSVData(this.options.source,this.options):"rss"==this.options.type||"RSS"==this.options.type?(this.options.format="xml",this.feed.__processRSSData(this.options.source,this.options)):"kml"==this.options.type||"KML"==this.options.type?(this.options.format="xml",this.feed.__processKMLData(this.options.source,this.options)):"gml"==this.options.type||"GML"==this.options.type?(this.options.format="xml",this.feed.__processGMLData(this.options.source,this.options)):"json"==this.options.type||"JSON"==this.options.type||"Json"==this.options.type?this.feed.__processJsonData(this.options.source,this.options):"geojson"==this.options.type||"GEOJSON"==this.options.type||"GeoJson"==this.options.type?this.feed.__processGeoJsonData(this.options.source,this.options):"topojson"==this.options.type||"TOPOJSON"==this.options.type||"TopoJson"==this.options.type?this.feed.__processTopoJsonData(this.options.source,this.options):"jsonDB"==this.options.type||"JSONDB"==this.options.type||"JsonDB"==this.options.type||"jsondb"==this.options.type?this.feed.__processJsonDBData(this.options.source,this.options):"parquet"==this.options.type||"PARQUET"==this.options.type?this.options.source instanceof ArrayBuffer&&(_LOG("Processing parquet ArrayBuffer directly: "+this.options.source.byteLength+" bytes"),this.feed.__processParquetData(this.options.source,this.options)):"geoparquet"!=this.options.type&&"GEOPARQUET"!=this.options.type||this.options.source instanceof ArrayBuffer&&(_LOG("Processing geoparquet ArrayBuffer directly: "+this.options.source.byteLength+" bytes"),this.feed.__processGeoParquetData(this.options.source,this.options)),this},error:function(e){return this.options.error=e,this}},n.Import=function(e){this.options=e,this.debug=!1},n.Feed=function(e){this.options=e||{},this.debug=!1,this.options.error=function(e){n.errors.push(e)}},n.Feed.prototype={load:function(e){this.options.success=e;const t=this.options,o=t.source||t.src||t.url||t.ext;void 0===t.cache&&(t.cache=!0,t.options&&void 0!==t.options.cache&&(t.cache=t.options.cache));const s=this;return o||l("Data.feed(...).load(): no source defined !",2e3),"csv"==t.type||"CSV"==t.type?this.__doCSVImport(o,t):"rss"==t.type||"RSS"==t.type?this.__doRSSImport(o,t):"kml"==t.type||"KML"==t.type?this.__doKMLImport(o,t):"gml"==t.type||"GML"==t.type?this.__doGMLImport(o,t):"json"==t.type||"JSON"==t.type||"Json"==t.type?this.__doJSONImport(o,t):"geojson"==t.type||"GEOJSON"==t.type||"GeoJson"==t.type?this.__doGeoJSONImport(o,t):"topojson"==t.type||"TOPOJSON"==t.type||"TopoJson"==t.type?this.__doTopoJSONImport(o,t):"jsonDB"==t.type||"JSONDB"==t.type||"JsonDB"==t.type||"jsondb"==t.type?this.__doJsonDBImport(o,t):"jsonstat"==t.type||"jsonStat"==t.type||"JSONSTAT"==t.type?$.getScript("http://json-stat.org/lib/json-stat.js").done((function(e,r){s.__doLoadJSONstat(o,t)})).fail((function(e,o,s){l("'"+t.type+"' unknown format !")})):"parquet"==t.type||"PARQUET"==t.type?this.__doParquetImport(o,t):l("'"+t.type+"' unknown format !"),this},error:function(e){return this.options.error=e,this}},n.feed=function(e){return new n.Feed(e)},n.object=function(e){return new n.Object(e)},n.import=function(e){return new n.Object(e).import().feed.dbtable};n.Feed.prototype.__doLoadJSONstat=function(e,t){const o=this;JSONstat(e,(function(){const e=[];let s=[this.Dataset(0).Dimension(0).label];const r=this.Dataset(0).Dimension(1).id;for(let e=0;e<r.length;e++)s.push(this.Dataset(0).Dimension(1).Category(r[e]).label);e.push(s);for(let t=0;t<this.Dataset(0).Dimension(0).length;t++){s=[],s.push(this.Dataset(0).Dimension(0).Category(this.Dataset(0).Dimension(0).id[t]).label);for(let e=0;e<this.Dataset(0).Dimension(1).length;e++)s.push(this.Dataset(0).Data([t,e]).value);e.push(s)}t.callback?t.callback(e,t):o.__createDataTableObject(e,t.type,t)}))},n.Feed.prototype.__doJsonDBImport=function(e,t){_LOG("__doJsonDBImport: "+e);const o=this;t.url=e,$.getScript(e+".gz").done((function(e,s){o.__processJsonDBData(e,t)})).fail((function(s,r,n){$.getScript(e).done((function(e,s){o.__processJsonDBData(e,t)})).fail((function(t,s,r){o.options.error&&o.options.error('"'+e+'" '+r)}))}))},n.Feed.prototype.__processJsonDBData=function(t,o){_LOG("__processJsonDBData:"),this.dbtable=new n.Table;let s=null;if("string"==typeof t){const t=o.source.split(/\//).pop().split(/\./)[0];s=void 0!==e?e[t]:global[t]}else s=o.source;this.dbtable.table=s.table,this.dbtable.fields=s.fields,this.dbtable.records=s.records,o.callback?o.callback(newData,o):void 0!==o&&o.success&&o.success(this.dbtable)},n.Feed.prototype.__doCSVImport=function(e,t){_LOG("__doCSVImport: "+e);const o=this;$.ajax({type:"GET",url:e,cache:t.cache,dataType:"text",success:function(e){o.__processCSVData(e,t)},error:function(o,s,r){void 0!==t&&t.error&&t.error('"'+e+'" '+r)}})},n.Feed.prototype.__processCSVData=function(e,t){if(_LOG("__processCSVData - start"),"undefined"==typeof Papa){_LOG("__processCSVData:load csv parser!");const o=this;return $.getScript("https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js").done((function(s,r){o.__processCSVData(e,t)})).fail((function(e,o,s){l("'"+t.type+"' parser not loaded !"),t.error&&t.error("'"+t.type+"' parser not loaded !")})),!1}let o=Papa.parse(e,t.parser);if(o.errors.length)return l("csv parsing error: "+o.errors.map((e=>e.message)).join(";")),t.error&&t.error("csv parsing error: "+o.errors.map((e=>e.message)).join(";")),!1;let s=o.data;if(s.length<2||void 0===s[0]||void 0===s[1])return l("csv parsing error: insufficient rows in data !"),t.error&&t.error("csv parsing error: insufficient rows in data !"),!1;if(!(t.parser&&t.parser.delimiter||s[0].length===s[1].length)){_LOG("csv parser: autodetect failed");const o=[";",","];let r=!1;for(const t of o){if(_LOG(`csv parser: delimiter = ${t}`),s=Papa.parse(e,{delimiter:t}).data,s[0].length===s[1].length){r=!0;break}_LOG(`csv parser: delimiter = ${t} failed`)}if(!r)return l("csv parsing error: unable to auto detect delimiter!"),t.error&&t.error("csv parsing error: unable to auto detect delimiter!"),!1}return s[s.length-1].length!==s[0].length&&s.length>1&&s.pop(),s[0].length-s[1].length==1&&""===s[0][s[0].length-1].trim()&&s[0].pop(),t.callback?(t.callback(s,t),!1):(_LOG("__createDataTableObject: "+(t.options?" -> "+t.options.name:"")),this.__createDataTableObject(s,t.type,t),!1)},n.Feed.prototype.__doRSSImport=function(e,t){_LOG("__doRSSImport: "+e);const o=this;t.format="xml",$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){o.__processRSSData(e,t)},error:function(e,o,s){void 0!==t&&t.error&&t.error(e,o,s)}})},n.Feed.prototype.__processRSSData=function(e,t){"xml"==t.format&&($(e).find("rss").length?this.__parseRSSData(e,t):$(e).find("feed").length?l("feed not yet supported"):$(e).find("atom").length&&l("atom not yet supported"))},n.Feed.prototype.__parseRSSData=function(e,t){const o=this;"xml"==t.format&&$(e).find("channel").each((function(){const s=[];let r=null;$(e).find("item").each((function(){if(!r){const e=[];r=[];const t=$(this).children();for(let o=0;o<t.length;o++){let t=$(this).children()[o].nodeName;for(;e[t];)t+="*";e[t]=t,r[o]=t}s.push(r)}const e=[];for(let t=0;t<r.length;t++)"enclosure"==r[t]?e.push($(this).find(r[t]+":first").attr("url")||""):e.push($(this).find(r[t]+":first").text()||"");s.push(e)})),o.__createDataTableObject(s,"rss",t)}))},n.Feed.prototype.__doKMLImport=function(e,t){_LOG("__doKMLImport: "+e);const o=this;t.format="xml",$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){o.__processKMLData(e,t)},error:function(e,o,s){void 0!==t&&t.error&&t.error(e,o,s)}})},n.Feed.prototype.__doGMLImport=function(e,t){_LOG("__doGMLImport: "+e);const o=this;t.format="xml",$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){o.__processGMLData(e,t)},error:function(e,o,s){void 0!==t&&t.error&&t.error(e,o,s)}})},n.Feed.prototype.__processKMLData=function(e,t){"xml"==t.format&&($(e).find("kml").length?this.__parseKMLData(e,t):l("feed not kml"))},n.Feed.prototype.__parseKMLData=function(e,t){const o=this;if("xml"==t.format){const s=$(e).find("Document"),r=[];let n=null;s.find("Placemark").each((function(){const e=$(this).find("ExtendedData")||$(this);n||(n=[],e.find("Data").each((function(){n.push($(this).attr("name"))})),$(this).find("Point").find("coordinates")&&n.push("KML.Point"),r.push(n));const t=[];e.find("Data").each((function(){t.push($(this).find("value").text())})),$(this).find("Point").find("coordinates")&&t.push($(this).find("Point").find("coordinates").text()),r.push(t)})),o.__createDataTableObject(r,"kml",t)}},n.Feed.prototype.__processGMLData=function(e,t){"xml"==t.format&&("string"==typeof e&&(parser=new DOMParser,e=parser.parseFromString(e,"text/xml")),$(e).find("wfs\\:FeatureCollection, gml\\:FeatureCollection, FeatureCollection").length?this.__parseGMLData(e,t):l("feed not gml"))},n.Feed.prototype.__parseGMLData=function(e,t){const o=this;if("xml"==t.format){const s=$(e).find("wfs\\:FeatureCollection, FeatureCollection").first();if(0===s.length)return void l("No FeatureCollection found in GML data");const r=[];let n=null;s.find("wfs\\:member, gml\\:featureMember, featureMember, gml\\:featureMembers, featureMembers").each((function(){const e=$(this).find("gml\\:*, *").first();if(0===e.length)return;n||(n=[],e.find("gml\\:*, *").each((function(){const e=$(this).prop("tagName");e&&!e.match(/^(gml:)?(boundedBy|location|pos|coordinates|geometry|geometryProperty)$/i)&&n.push(e.replace(/^gml:/,""))})),n.push("GML.Geometry"),r.push(n));const t=[];e.find("gml\\:*, *").each((function(){const e=$(this).prop("tagName");e&&!e.match(/^(gml:)?(boundedBy|location|pos|coordinates|geometry|geometryProperty)$/i)&&t.push($(this).text())}));const o=e.find("gml\\:Polygon").first();if(o.length>0){let e='{"type":"Polygon","coordinates":[[',r=o.text().split(" "),n=0;for(var s=0;s<r.length;s++)if(Number(r[s])&&!isNaN(Number(r[s]))){n=s;break}if(n<r.length-1)for(s=n;s<r.length-1;s+=2)r[s]&&r[s+1]&&!isNaN(Number(r[s]))&&!isNaN(Number(r[s+1]))&&(e+=(s>n?",":"")+"["+r[s+1]+","+r[s]+"]");e+="]]}",t.push(e)}else t.push("");r.push(t)})),o.__createDataTableObject(r,"gml",t)}},n.Feed.prototype.__doJSONImport=function(e,t){const o=this;$.get(e,(function(e){o.__processJsonData(e,t)})).fail((function(e){void 0!==t&&t.error&&t.error(e)}))},__getNestedPaths=function(e,t=""){const o=[];if("object"!=typeof e||null===e||Array.isArray(e))Array.isArray(e)?e.forEach(((e,s)=>{const r=t?`${t}.${s}`:String(s);o.push(...__getNestedPaths(e,r))})):o.push(t);else for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)){const r=e[s],n=t?`${t}.${s}`:s;o.push(...__getNestedPaths(r,n))}return o},__extractValuesRecursive=function(e,t){let s=[];if(null==e)s.push("null");else if("object"!=typeof t||null===t||Array.isArray(t))if(Array.isArray(t))for(let r=0;r<t.length;r++){const n=r<e.length?e[r]:o;s=s.concat(__extractValuesRecursive(n,t[r]))}else s.push(e);else for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){const n=Object.prototype.hasOwnProperty.call(e,r)?e[r]:o;s=s.concat(__extractValuesRecursive(n,t[r]))}return s},n.Feed.prototype.__processJsonData=function(e,t){let o=null;if("string"==typeof e)try{o=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else o=e;this.data=o;let s=[],r=[];if(o&&o.data&&o.data.columns&&o.data.rows){const e=o.data.columns,t=o.data.rows;for(let t=0,o=e.length;t<o;t++)r.push(e[t]);s.push(r);for(let e=0,o=t.length;e<o;e++){r=[];for(let o=0,s=t[0].length;o<s;o++)r.push(t[e][o]);s.push(r)}}else{if(o&&o.data&&(o=o.data),!Array.isArray(o)){__findAllArraysInJson=function(e){const t=[];return function e(o){if(Array.isArray(o))t.push(o);else if("object"==typeof o&&null!==o)for(const t in o)o.hasOwnProperty(t)&&e(o[t])}(e),t},o=__findAllArraysInJson(o)[0]}if(!o){let o=[];o.push(["unknown type"]);const s=e.split("\n");for(let e=0,t=s.length;e<t;e++)o.push([s[e]]);return void this.__createDataTableObject(o,"json",t)}s.push(__getNestedPaths(o[0]));for(let e=0;e<o.length;e++)s.push(__extractValuesRecursive(o[e],o[0]))}this.__createDataTableObject(s,"json",t)},n.Feed.prototype.__doGeoJSONImport=function(e,t){const o=this;$.get(e,(function(e){o.__processGeoJsonData(e,t)})).fail((function(e){void 0!==t&&t.error&&t.error(e)}))},n.Feed.prototype.__processGeoJsonData=function(e,t){let s=null;if("string"==typeof e)try{s=JSON.parse(e)}catch(e){return void this.__createDataTableObject([],"json",t)}else s=e;this.data=s;const r=[],n={};if(s&&s.features&&s.features.length){for(const e of s.features)if(e.properties)for(const t in e.properties)n[t]=!0;const e=Object.keys(n);e.push("geometry"),r.push(e);for(const t of s.features){const s=[],n=t.properties||{};for(let t=0;t<e.length-1;t++){const r=n[e[t]];"object"==typeof r?s.push(JSON.stringify(r)):s.push(r!==o?r:"")}s.push(JSON.stringify(t.geometry)),r.push(s)}}this.__createDataTableObject(r,"json",t)},n.Feed.prototype.__processGeoJsonData_expandProperty=function(e,t){let o=null;if("string"==typeof e)try{o=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else o=e;this.data=o;let s=[],r=[];const n=[];if(o&&o.features&&o.features.length){for(let e=0;e<o.features.length;e++)for(const t in o.features[e].properties)if("string"==typeof o.features[e].properties[t]||"number"==typeof o.features[e].properties[t])n[t]=!0;else for(const s in o.features[e].properties[t])n[t+"."+s]=!0;for(const e in n)r.push(e);r.push("geometry"),s.push(r);for(let e=0;e<o.features.length;e++){r=[];for(let t=0;t<s[0].length-1;t++){const n=s[0][t].split(".");n.length>=2?r.push(o.features[e].properties[n[0]][n[1]]||""):r.push(o.features[e].properties[s[0][t]]||"")}r.push(JSON.stringify(o.features[e].geometry)),s.push(r)}}this.__createDataTableObject(s,"json",t)},n.Feed.prototype.__doTopoJSONImport=function(e,t){const o=this;$.get(e,(function(e){o.__processTopoJsonData(e,t)})).fail((function(e){void 0!==t&&t.error&&t.error(e)}))},n.Feed.prototype.__processTopoJsonData=function(e,t){if("undefined"==typeof topojson)return void l("'"+t.type+"' parser not loaded !");let o=null;if("string"==typeof e)try{o=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else o=e;this.data=o;let s=null;if(t.options&&t.options.name&&o.objects[t.options.name])s=topojson.feature(o,o.objects[t.options.name]);else for(var r in o.objects){s=topojson.feature(o,o.objects[r]);break}for(const e in s.features)s.features[e].properties.id=s.features[e].id;this.__processGeoJsonData(s,t)},n.Feed.prototype.__doParquetImport=function(e,t){_LOG("__doParquetImport: "+e);const o=this;_LOG("Attempting to load parquet file using Fetch API..."),fetch(e,{method:"GET",cache:t.cache?"default":"no-cache"}).then((e=>{if(_LOG("Fetch response received, status: "+e.status),_LOG("Response headers: "+JSON.stringify([...e.headers.entries()])),!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.arrayBuffer()})).then((e=>{_LOG("Successfully loaded parquet as ArrayBuffer: "+e.byteLength+" bytes");const s=new Uint8Array(e);if(s.length>=4){const r=String.fromCharCode(...s.slice(0,4));_LOG("Magic number: "+r),"PAR1"===r?(_LOG("‚úÖ SUCCESS: Valid parquet file detected!"),o.__processParquetData(e,t)):(_LOG("‚ö†Ô∏è Warning: Magic number is not PAR1: "+r),_LOG("First 16 bytes: "+Array.from(s.slice(0,16)).map((e=>e.toString(16).padStart(2,"0"))).join(" ")),_LOG("Attempting to process anyway..."),o.__processParquetData(e,t))}else _LOG("‚ö†Ô∏è Warning: Response too short to check magic number"),o.__processParquetData(e,t)})).catch((s=>{_LOG("Fetch failed: "+s.message),_LOG("Falling back to XMLHttpRequest..."),o.__loadParquetWithXHR(e,t)}))},n.Feed.prototype.__loadParquetWithXHR=function(e,t){const o=this;_LOG("Loading parquet with XMLHttpRequest...");const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){if(200===s.status){const e=s.response;_LOG("XHR successful: "+e.byteLength+" bytes");const r=new Uint8Array(e);if(r.length>=4){const s=String.fromCharCode(...r.slice(0,4));_LOG("XHR magic number: "+s),"PAR1"===s?(_LOG("‚úÖ SUCCESS: Valid parquet file via XHR!"),o.__processParquetData(e,t)):(_LOG("‚ö†Ô∏è Warning: XHR magic number is not PAR1: "+s),_LOG("First 16 bytes: "+Array.from(r.slice(0,16)).map((e=>e.toString(16).padStart(2,"0"))).join(" ")),_LOG("Attempting to process anyway..."),o.__processParquetData(e,t))}else _LOG("‚ö†Ô∏è Warning: XHR response too short to check magic number"),o.__processParquetData(e,t)}else _LOG("XHR failed with status: "+s.status+" "+s.statusText),void 0!==t&&t.error?t.error("XHR failed: "+s.status+" "+s.statusText):l("XHR failed: "+s.status+" "+s.statusText)},s.onerror=function(){_LOG("XHR network error"),void 0!==t&&t.error?t.error("XHR network error"):l("XHR network error")},s.send()},n.Feed.prototype.__checkGeoParquetMetadataWithDuckDB=function(t,o,s){try{const s=t.slice(),r="temp_parquet_"+Date.now()+".parquet";e.duckdb.db.registerFileBuffer(r,new Uint8Array(s)).then((function(){const t=`\n                        SELECT * FROM read_parquet('${r}') LIMIT 1\n                    `;return e.duckdb.conn.query(t)})).then((function(e){let t,s=!1;if("function"==typeof e.toArray)t=e.toArray();else if("function"==typeof e.fetchAll)t=e.fetchAll();else if(Array.isArray(e))t=e;else{if(!e.data||!Array.isArray(e.data))return void o(!1);t=e.data}if(t&&t.length>0){const e=t[0],o=Object.keys(e),r=["geometry","geom","the_geom","wkb_geometry","shape"];for(const e of o){const t=e.toLowerCase();if(r.includes(t)){s=!0;break}}for(const e of o){const t=e.toLowerCase();if(t.includes("wkb")||t.includes("geojson")||t.includes("wkt")||t.includes("coordinates")){s=!0;break}}}o(s)})).catch((function(e){o(!1)})).finally((function(){try{e.duckdb.db.dropFile(r)}catch(e){}}))}catch(e){s(e)}},n.Feed.prototype.__processStreamingDataset=function(t,s,r,n){const i=this,l=()=>{if(performance.memory){Math.round(performance.memory.usedJSHeapSize/1024/1024),Math.round(performance.memory.totalJSHeapSize/1024/1024)}},a=[s],c=async(e,r)=>new Promise((n=>{setTimeout((()=>{const i=[];for(let n=e;n<r;n++){const e=[];for(let r=0;r<s.length;r++){let i;if(i=Array.isArray(t[n])?t[n][r]:"object"==typeof t[n]&&null!==t[n]?t[n][s[r]]:t[n],null===i||i===o)e.push("");else if(i instanceof Date)e.push(i.toISOString());else if("object"==typeof i&&null!==i)try{e.push(JSON.stringify(i))}catch(t){e.push(String(i))}else e.push(String(i))}i.push(e)}n(i)}),0)}));return(async()=>{const e=1e6;for(let o=0;o<t.length;o+=e){const s=Math.min(o+e,t.length),r=await c(o,s);for(let e=0;e<r.length;e++)a.push(r[e]);r.length=0,s%2e6!=0&&s!==t.length||l(),await new Promise((e=>setTimeout(e,0)))}})().then((function(){_LOG("Streaming dataset converted: "+a.length+" total rows (including header)");try{e.duckdb.db.dropFile(r)}catch(e){}i.__createDataTableObject(a,"parquet",n)})).catch((function(t){try{e.duckdb.db.dropFile(r)}catch(e){}n&&"function"==typeof n.error&&n.error(t)}))},n.Feed.prototype.__processParquetData=function(t,o){const s=this;_LOG("Processing parquet data with DuckDB WASM..."),void 0!==e.duckdb&&e.duckdbLoaded?s.__processParquetWithDuckDB(t,o):s.__loadDuckDBAndProcess(t,o)},n.Feed.prototype.__processParquetWithDuckDB=function(e,t){const o=this;_LOG("Detecting if parquet file is GeoParquet..."),o.__checkGeoParquetMetadataWithDuckDB(e,(function(s){s?(_LOG("‚úÖ GeoParquet detected! Switching to GeoParquet processing..."),"function"==typeof o.__processGeoParquetData?o.__processGeoParquetData(e,t):(_LOG("‚ö†Ô∏è GeoParquet processing function not found, falling back to regular parquet processing"),o.__processWithDuckDB(e,t))):(_LOG("‚úÖ Regular parquet file detected, proceeding with standard processing..."),o.__processWithDuckDB(e,t))}),(function(s){_LOG("‚ö†Ô∏è Error detecting GeoParquet, falling back to regular parquet processing: "+s),o.__processWithDuckDB(e,t)}))},n.Feed.prototype.__loadDuckDBAndProcess=function(o,s){const r=this;_LOG("Loading DuckDB WASM module dynamically...");const n=t.createElement("script");n.type="module",n.textContent='\n            // Try to load DuckDB WASM from CDN\n            let duckdb;\n            try {\n                // Try jsDelivr first (most reliable for DuckDB WASM)\n                duckdb = await import("https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm");\n                console.log("‚úÖ DuckDB loaded from jsDelivr");\n            } catch (e1) {\n                try {\n                    // Fallback to ESM.sh\n                    duckdb = await import("https://esm.sh/@duckdb/duckdb-wasm@1.30.0");\n                    console.log("‚úÖ DuckDB loaded from ESM.sh");\n                } catch (e2) {\n                    try {\n                        // Fallback to unpkg\n                        duckdb = await import("https://unpkg.com/@duckdb/duckdb-wasm@1.30.0");\n                        console.log("‚úÖ DuckDB loaded from unpkg");\n                    } catch (e3) {\n                        throw new Error("Failed to load DuckDB from any CDN: " + e3.message);\n                    }\n                }\n            }\n            \n            console.log("DuckDB WASM module imported:", duckdb);\n            console.log("Available DuckDB methods:", Object.keys(duckdb));\n            \n            // Initialize DuckDB\n            try {\n                console.log(\'üîß Selecting bundle from jsDelivr CDN...\');\n                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();\n                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);\n                \n                console.log("üë∑ Creating worker from bundle...");\n                // Create worker using blob URL approach to avoid CORS issues\n                const worker_url = URL.createObjectURL(\n                    new Blob([`importScripts("${bundle.mainWorker}");`], { type: \'text/javascript\' })\n                );\n                const worker = new Worker(worker_url);\n                console.log("‚úÖ Worker created successfully");\n                \n                const logger = new duckdb.ConsoleLogger();\n                const db = new duckdb.AsyncDuckDB(logger, worker);\n                \n                console.log("üöÄ Instantiating DuckDB with WASM module...");\n                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);\n                console.log("‚úÖ DuckDB WASM instantiated successfully");\n                \n                // Revoke the blob URL to free memory\n                URL.revokeObjectURL(worker_url);\n                \n                // Create connection\n                const conn = await db.connect();\n                \n                console.log("‚úÖ DuckDB WASM initialized successfully");\n                console.log("üìä DuckDB connection object type:", typeof conn);\n                console.log("üìä DuckDB connection methods:", Object.getOwnPropertyNames(conn));\n                console.log("üìä DuckDB connection constructor:", conn.constructor.name);\n                \n                // Store references globally\n                window.duckdb = {\n                    db: db,\n                    conn: conn,\n                    module: duckdb\n                };\n                window.duckdbLoaded = true;\n            \n            } catch (error) {\n                console.error("‚ùå Failed to initialize DuckDB WASM:", error);\n                window.duckdbLoadError = error;\n            }\n            ',t.head.appendChild(n);const i=setInterval((function(){e.duckdbLoaded&&e.duckdb?(clearInterval(i),_LOG("DuckDB WASM module loaded successfully"),r.__processParquetWithDuckDB(o,s)):e.duckdbLoadError&&(clearInterval(i),_LOG("Failed to load DuckDB WASM module: "+e.duckdbLoadError),void 0!==s&&s.error?s.error("Failed to load DuckDB WASM module: "+e.duckdbLoadError):l("Failed to load DuckDB WASM module: "+e.duckdbLoadError))}),100);setTimeout((function(){e.duckdbLoaded||e.duckdbLoadError||(clearInterval(i),_LOG("Timeout loading DuckDB WASM module"),void 0!==s&&s.error?s.error("Timeout loading DuckDB WASM module"):l("Timeout loading DuckDB WASM module"))}),15e3)},n.Feed.prototype.__processWithDuckDB=function(t,s){const r=this;try{if(_LOG("Processing parquet data with DuckDB WASM, buffer size: "+t.byteLength+" bytes"),t.byteLength<4)throw new Error("File too small to be a valid parquet file");const n=new Uint8Array(t),i=String.fromCharCode(...n.slice(0,4));if(_LOG("Parquet file magic number: "+i),"PAR1"!==i)throw new Error("File does not appear to be a valid parquet file (missing PAR1 magic number). Magic: "+i);_LOG("Valid parquet file detected, processing with DuckDB WASM...");const a="temp_parquet_"+Date.now()+".parquet",c=new Uint8Array(n);e.duckdb.db.registerFileBuffer(a,c).then((function(){const t=`SELECT * FROM read_parquet('${a}') LIMIT 2000000`;return e.duckdb.conn.query(t)})).then((async function(e){if(_LOG("DuckDB query result type: "+typeof e),!e)throw new Error("DuckDB query returned null/undefined");let t,n;if("function"==typeof e.toArray)t=e.toArray();else if("function"==typeof e.fetchAll)t=e.fetchAll();else if(Array.isArray(e))t=e;else{if(!e.data||!Array.isArray(e.data))throw new Error("Cannot convert DuckDB result to array. Available methods: "+Object.getOwnPropertyNames(e).join(", "));t=e.data}if(0===t.length)throw new Error("No rows found in parquet file");if(e.schema&&e.schema.fields)n=e.schema.fields.map((e=>e.name));else if(e.columns)n=e.columns;else{if(!(t.length>0&&"object"==typeof t[0]))throw new Error("Cannot determine column names from DuckDB result");n=Object.keys(t[0])}if(_LOG("Extracted columns: "+n.join(", ")),0===n.length)throw new Error("No columns found in parquet file");const i=[];if(t.length>2e6)throw new Error(`Dataset too large (${t.length} rows). Maximum supported: 2,000,000 rows. Consider using a smaller LIMIT in your query.`);if(t.length>1e5)return r.__processStreamingDataset(t,n,a,s);t.length;const l=Math.min(2e6,Math.max(5e5,Math.floor(t.length/1)));if(t.length>5e4){const e=t.length>5e5?1e6:Math.min(2e6,l);try{const s=async(e,s)=>new Promise((r=>{setTimeout((()=>{const i=[];for(let r=e;r<s;r++){const e=[];for(let s=0;s<n.length;s++){let i;if(i=Array.isArray(t[r])?t[r][s]:"object"==typeof t[r]&&null!==t[r]?t[r][n[s]]:t[r],null===i||i===o)e.push("");else if(i instanceof Date)e.push(i.toISOString());else if("object"==typeof i&&null!==i)try{e.push(JSON.stringify(i))}catch(t){e.push(String(i))}else e.push(String(i))}i.push(e)}r(i)}),0)}));for(let o=0;o<t.length;o+=e){const r=Math.min(o+e,t.length),n=await s(o,r);for(let e=0;e<n.length;e++)i.push(n[e]);n.length=0,r%(10*e)==0||t.length,t.length>1e5&&await new Promise((e=>setTimeout(e,0))),t.length>5e5&&r%(2*e)==0&&await new Promise((e=>setTimeout(e,0)))}}catch(e){const s=1e3;for(let e=0;e<t.length;e+=s){const r=Math.min(e+s,t.length);for(let s=e;s<r;s++){const e=[];for(let r=0;r<n.length;r++){let i;if(i=Array.isArray(t[s])?t[s][r]:"object"==typeof t[s]&&null!==t[s]?t[s][n[r]]:t[s],null===i||i===o)e.push("");else if(i instanceof Date)e.push(i.toISOString());else if("object"==typeof i&&null!==i)try{e.push(JSON.stringify(i))}catch(t){e.push(String(i))}else e.push(String(i))}i.push(e)}}}}else for(let e=0;e<t.length;e+=l){const s=Math.min(e+l,t.length);for(let r=e;r<s;r++){const e=[];for(let s=0;s<n.length;s++){let i;if(i=Array.isArray(t[r])?t[r][s]:"object"==typeof t[r]&&null!==t[r]?t[r][n[s]]:t[r],null===i||i===o)e.push("");else if(i instanceof Date)e.push(i.toISOString());else if("object"==typeof i&&null!==i)try{e.push(JSON.stringify(i))}catch(t){e.push(String(i))}else e.push(String(i))}i.push(e)}t.length}_LOG("Converted "+i.length+" rows with "+n.length+" columns");const c=[n];c.push(...i),r.__createDataTableObject(c,"parquet",s)})).catch((function(e){_LOG("Error in DuckDB parquet processing: "+e),void 0!==s&&s.error?s.error("Error processing parquet file with DuckDB: "+e.message):l("Error processing parquet file with DuckDB: "+e.message)})).finally((function(){try{e.duckdb.db.dropFile(a)}catch(e){}}))}catch(e){_LOG("Error in DuckDB parquet processing setup: "+e),void 0!==s&&s.error?s.error("Error setting up DuckDB parquet processing: "+e.message):l("Error setting up DuckDB parquet processing: "+e.message)}},n.Feed.prototype.__processGeoParquetData=function(o,s){const r=this;if(void 0!==e.geoparquet)_LOG("GeoParquet library already loaded, processing data..."),r.__processWithGeoParquet(o,s,e.geoparquet);else{_LOG("Loading GeoParquet library dynamically...");const n=t.createElement("script");n.type="module",n.textContent='\n                import { asyncBufferFromUrl, toGeoJson } from \'https://cdn.jsdelivr.net/npm/geoparquet@0.5.0/+esm\';\n                \n                console.log("GeoParquet module imported");\n                console.log("Available geoparquet methods:", Object.keys({ asyncBufferFromUrl, toGeoJson }));\n                \n                // Make geoparquet available globally\n                window.geoparquet = { asyncBufferFromUrl, toGeoJson };\n                window.geoparquetLoaded = true;\n            ';const i=setInterval((function(){e.geoparquetLoaded&&e.geoparquet&&(clearInterval(i),_LOG("GeoParquet module loaded successfully"),r.__processWithGeoParquet(o,s,e.geoparquet))}),100);setTimeout((function(){e.geoparquetLoaded||(clearInterval(i),_LOG("Failed to load GeoParquet module"),void 0!==s&&s.error?s.error("Failed to load GeoParquet module"):l("Failed to load GeoParquet module"))}),1e4),t.head.appendChild(n)}},n.Feed.prototype.__processWithGeoParquet=function(e,t,o){try{if(_LOG("Processing GeoParquet data, buffer size: "+e.byteLength+" bytes"),_LOG("GeoParquet object: "+JSON.stringify(o)),_LOG("Available geoparquet methods: "+Object.keys(o).join(", ")),e.byteLength<4)throw new Error("File too small to be a valid parquet file");const s=new Uint8Array(e),r=String.fromCharCode(...s.slice(0,4));if(_LOG("Parquet file magic number: "+r),"PAR1"!==r)throw new Error("File does not appear to be a valid parquet file (missing PAR1 magic number). Magic: "+r);if(_LOG("Valid parquet file detected, processing with geoparquet..."),"function"!=typeof o.toGeoJson)throw new Error("toGeoJson method not found in geoparquet. Available methods: "+Object.keys(o).join(", "));_LOG("Calling geoparquet.toGeoJson...");const n=o.toGeoJson({file:e});if(_LOG("GeoJSON conversion result type: "+typeof n),_LOG("GeoJSON conversion result: "+JSON.stringify(n)),n&&"function"==typeof n.then){_LOG("GeoJSON conversion is a Promise, waiting for resolution...");const e=this;n.then((function(o){try{_LOG("GeoJSON conversion completed successfully"),_LOG("GeoJSON type: "+o.type),_LOG("Number of features: "+(o.features?o.features.length:"unknown")),e.__processGeoJsonData(o,t)}catch(e){throw _LOG("Error processing GeoJSON data: "+e),new Error("Error processing GeoJSON data: "+e)}})).catch((function(e){_LOG("Error in GeoJSON conversion: "+e),_LOG("Error stack: "+e.stack),_LOG("Error message: "+e.message),void 0!==t&&t.error?t.error("Error converting GeoParquet to GeoJSON: "+e):l("Error converting GeoParquet to GeoJSON: "+e)}))}else{if(_LOG("GeoJSON conversion returned directly"),!n)throw new Error("GeoJSON conversion returned null or undefined");_LOG("GeoJSON type: "+n.type),_LOG("Number of features: "+(n.features?n.features.length:"unknown")),this.__processGeoJsonData(n,t)}}catch(e){_LOG("Error processing GeoParquet data: "+e),void 0!==t&&t.error?t.error("Error processing GeoParquet data: "+e):l("Error processing GeoParquet data: "+e)}},n.Feed.prototype.__createDataTableObject=function(e,t,o){if(e)return this.dbtable=(new n.Table).setArray(e),e=null,void(void 0!==o&&o.success?o.success(this.dbtable):_LOG("callback to call on succes is 'undefined'!"))},n.Table=function(e){e?(this.table=e.table,this.fields=e.fields,this.records=e.records):(this.table={records:0,fields:0},this.fields=[],this.records=[])},n.Table.prototype={getArray:function(){let e=[[]];for(let t=0,o=this.fields.length;t<o;t++)e[0].push(this.fields[t].id);for(let t=0,o=this.records.length;t<o;t++)e.push(this.records[t]);return e},setArray:function(e){this.fields=[];for(let t=0,o=e[0].length;t<o;t++)this.fields.push({id:(e[0][t]||" ").trim(),typ:0,width:60,decimals:0});e.shift(),this.records=[];for(let t=0,o=e.length;t<o;t++)e[t].length==this.fields.length&&this.records.push(e[t]);return this.table={records:this.records.length,fields:this.fields.length},this},revert:function(){let e=[];for(let t=this.records.length-1;t>=0;t--)e.push(this.records[t]);return this.records=e,this},reverse:function(){let e=[];for(let t=this.records.length-1;t>=0;t--)e.push(this.records[t]);return this.records=e,this},columnNames:function(){const e=[];for(let t=0,o=this.fields.length;t<o;t++)e.push(this.fields[t].id);return e},columnIndex:function(e){for(var t in this.fields)if(this.fields[t].id==e)return t;return null},column:function(e){for(let t in this.fields)if(this.fields[t].id==e){const e=new n.Column;return e.index=t,e.table=this,e}return null},lookupArray:function(e,t){let o="overwrite";e&&e.key&&(o=e.calc||o,t=e.key,e=e.value);let s=[];this.column(t)||alert("'"+t+"' column not found!"),this.column(e)||alert("'"+e+"' column not found!");const r=this.column(t).values(),n=this.column(e).values();if("sum"==o)for(let e=0,t=r.length;e<t;e++)s[String(r[e])]=(s[String(r[e])]||0)+n[e];else if("max"==o)for(let e=0,t=r.length;e<t;e++)s[String(r[e])]=Math.max(s[String(r[e])]||0,n[e]);else for(let e=0,t=r.length;e<t;e++)s[String(r[e])]=n[e];return s},lookupStringArray:function(e,t){e&&e.key&&(t=e.key,e=e.value);let o=[];this.column(t)||alert("'"+t+"' column not found!"),this.column(e)||alert("'"+e+"' column not found!");const s=this.column(t).values(),r=this.column(e).values();for(let e=0,t=s.length;e<t;e++)o[String(s[e])]=o[String(s[e])]?o[String(s[e])]+", "+r[e]:r[e];return o},lookup:function(e,t){const o=t.value,s=t.lookup,r=o+"_"+s;return this.lookupsA&&this.lookupsA[r]||(this.lookupsA=this.lookupsA||[],this.lookupsA[r]=this.lookupArray(o,s)),this.lookupsA[r][e]||"-"},toKeyValue:function(e){return this.lookupArray(e.value,e.key)},addColumn:function(e,t){if(!e.destination)return alert("'data.addColumn' no destination defined!"),null;var o=null;if(e.source){for(let t=0,s=this.fields.length;t<s;t++)this.fields[t].id==e.source&&(o=t);if(null==o)return alert("'data.addColumn' source column '"+e.source+"' not found!"),null}if(this.fields.push({id:String(e.destination),created:!0}),this.table.fields++,t&&"function"==typeof t)for(let e=0,s=this.records.length;e<s;e++)this.records[e].push(null!=o?t(this.records[e][o],this.records[e]):t(this.records[e]));else if(t&&"object"==typeof t)for(let e=0,o=this.records.length;e<o;e++)this.records[e].push(t[e]||0);else if(e.values&&"object"==typeof e.values)for(let t=0,o=this.records.length;t<o;t++)this.records[t].push(e.values[t]||0);else for(let e=0,t=this.records.length;e<t;e++)this.records[e].push(0);return this},addRow:function(e){if(!e||"object"!=typeof e)return alert("'data.addRow' no options defined!"),null;var t=[];for(let e=0,o=this.fields.length;e<o;e++)t.push("");for(var o in e)this.column(o)?t[this.column(o).index]=e[o]:alert("'data.addRow' column '"+o+"' not found!");return this.records.push(t),this.table.records++,this},filter:function(e){this.selection=new n.Table;for(const t in this.records)e&&e(this.records[t])&&(this.selection.records.push(this.records[t]),this.selection.table.records++);return this.selection.fields=this.fields.slice(),this.selection.table.fields=this.table.fields,this.selection},select:function(e){if(e.match(/WHERE/)){if(1){let t=e.split("WHERE")[1].trim().split(" ");for(let e=0;e<t.length;e++)if(t[e].length){if('"'==t[e][0]&&'"'!=t[e][t[e].length-1])do{t[e]=t[e]+" "+t[e+1],t.splice(e+1,1)}while('"'!=t[e][t[e].length-1]);if("("==t[e][0]&&")"!=t[e][t[e].length-1])do{t[e]=t[e]+" "+t[e+1],t.splice(e+1,1)}while(")"!=t[e][t[e].length-1])}else t.splice(e,1),e--;this.filterQueryA=[];let o={},s="";do{let r=0;if(t.length>=3&&(o={},o.szSelectionField=t[0].replace(/("|)/g,""),o.szSelectionOp=t[1],o.szSelectionValue=t[2].replace(/("|)/g,""),r=3),"BETWEEN"==o.szSelectionOp&&t.length>=5&&"AND"==t[3]&&(o.szSelectionValue2=t[4],r=5),!r){l("data.js - selection error - incomplete query!\nquery: "+e);break}for(let e=0;e<this.fields.length;e++)this.fields[e].id==o.szSelectionField&&(o.nFilterFieldIndex=e),"$"+this.fields[e].id+"$"==o.szSelectionValue&&(o.nFilterValueIndex=e);if(o.szCombineOp=s,this.filterQueryA.push(o),t.splice(0,r),t.length&&"AND"==t[0])s="AND",t.splice(0,1);else{if(!t.length||"OR"!=t[0])break;s="OR",t.splice(0,1)}}while(t.length)}this.selection=new n.Table;for(let t=0;t<this.filterQueryA.length;t++)if(void 0===this.filterQueryA[t].nFilterFieldIndex)return this.selection.fields=this.fields.slice(),this.selection.table.fields=this.table.fields,_LOG("Selection: invalid query: "+e),this.selection;for(let e=0,t=this.records.length;e<t;e++){let t=null;for(let o=0,s=this.filterQueryA.length;o<s;o++){let s=!0;this.__szValue=String(this.records[e][this.filterQueryA[o].nFilterFieldIndex]),this.__szSelectionOp=this.filterQueryA[o].szSelectionOp.toUpperCase(),this.__szSelectionValue=this.filterQueryA[o].szSelectionValue,this.__szSelectionValue2=this.filterQueryA[o].szSelectionValue2,this.__szCombineOp=this.filterQueryA[o].szCombineOp,null!=this.filterQueryA[o].nFilterValueIndex&&(this.__szSelectionValue=String(this.records[e][this.filterQueryA[o].nFilterValueIndex]));let r=__scanValue(this.__szValue);if("="==this.__szSelectionOp)s="*"==this.__szSelectionValue?""!=this.__szValue.replace(/ /g,""):this.__szValue==this.__szSelectionValue||r==Number(this.__szSelectionValue);else if("<>"==this.__szSelectionOp)s=!(this.__szValue==this.__szSelectionValue||r==Number(this.__szSelectionValue));else if(">"==this.__szSelectionOp)s=r>Number(this.__szSelectionValue);else if("<"==this.__szSelectionOp)s=r<Number(this.__szSelectionValue);else if(">="==this.__szSelectionOp)s=r>=Number(this.__szSelectionValue);else if("<="==this.__szSelectionOp)s=r<=Number(this.__szSelectionValue);else if("LIKE"==this.__szSelectionOp)if("*"==this.__szSelectionValue)s=this.__szValue.length;else{const e=this.__szSelectionValue.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");s=new RegExp(e,"i").test(this.__szValue)}else if("NOT"==this.__szSelectionOp){const e=this.__szSelectionValue.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");s=!new RegExp(e,"i").test(this.__szValue)}else if("IN"==this.__szSelectionOp){s=this.__szSelectionValue.split(",").map((e=>e.trim())).includes(this.__szValue)}else if("BETWEEN"==this.__szSelectionOp)s=r>=Number(this.__szSelectionValue)&&r<=Number(this.__szSelectionValue2);else{const e=this.__szSelectionValue.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");s=new RegExp(e,"i").test(this.__szValue)}t="AND"==this.__szCombineOp?t&&s:t||s}t&&(this.selection.records.push(this.records[e].slice()),this.selection.table.records++)}}return this.selection.fields=this.fields.slice(),this.selection.table.fields=this.table.fields,this.selection},aggregate:function(e,t){let o=!1;e.lead&&(o=e.calc&&"mean"==e.calc,t=e.lead,e=e.column||e.value);const s=t.split("|"),r=[];let i=null;for(let t=0;t<s.length;t++)for(let o=0;o<this.fields.length;o++)this.fields[o].id==s[t]&&(r[t]=o),this.fields[o].id==e&&(i=o);this.aggregation=new n.Table,xRecords=[],xCount=[];for(let e=0,t=this.records.length;e<t;e++){const t=[];for(let o=0,s=r.length;o<s;o++)t.push(this.records[e][r[o]]);const o=t.join("");if(xRecords[o])xRecords[o][r.length]+=__scanValue(this.records[e][i]),xCount[o][r.length]++;else{xRecords[o]=[],xRecords[o][r.length]=__scanValue(this.records[e][i]);for(let t=0;t<r.length;t++)xRecords[o][t]=this.records[e][r[t]];xCount[o]=[],xCount[o][r.length]=1}}for(let e=0,t=xRecords.length;e<t;e++)o&&(xRecords[e][r.length]/=xCount[e][r.length]),this.aggregation.records.push(xRecords[e]),this.aggregation.table.records++;const l=[];for(let e=0;e<s.length;e++)l[e]={id:s[e]};return l[s.length]={id:e},this.aggregation.fields=l,this.aggregation.table.fields=l,this.aggregation},condense:function(e,t){const o={},s=[];e&&e.lead&&(e=(t=e).lead);const r=this.columnIndex(e);if(t&&t.keep)if("string"==typeof t.keep)s[this.columnIndex(t.keep)]=!0;else for(i=0;i<t.keep.length;i++)s[this.columnIndex(t.keep[i])]=!0;const l=[];for(let e=0;e<this.records.length;e++){const n=String(this.records[e][r]);if(null!=o[n]){const r=o[n];for(let o=0,n=this.records[e].length;o<n;o++)if(!s[o])if(isNaN(this.records[e][o])){if(isNaN(this.records[e][o])&&l[r][o]!=this.records[e][o]){let e=parseFloat(String(l[r][o]).split(" (+")[1])||0;l[r][o]=String(l[r][o]).split(" (+")[0]+" (+"+ ++e+") "}}else t&&"max"==t.calc?l[r][o]=Math.max(Number(l[r][o]),Number(this.records[e][o])):l[r][o]=Number(l[r][o])+Number(this.records[e][o])}else l.push(this.records[e].slice()),o[n]=l.length-1}return this.__condense=new n.Table,this.__condense.fields=this.fields,this.__condense.table.fields=this.fields,this.__condense.records=l.slice(),this.__condense.table.records=this.__condense.records.length,this.__condense},groupColumns:function(e){let t=e.source,o=[];for(let e=0,s=t.length;e<s;e++)o[e]=this.column(t[e]).index;return this.addColumn({destination:e.destination},(function(e){let t=0;for(let s=0,r=o.length;s<r;s++)t+=Number(e[o[s]]);return t})),this},pivot:function(e){e.lead=e.lead||e.rows,e.cols=e.cols||e.columns,e.keep=e.keep||[],e.sum=e.sum||[],e.lead=s(e.lead),e.cols=s(e.cols),e.keep=s(e.keep),e.sum=s(e.sum),e.value=s(e.value),e.forced=s(e.forced);let t=[];for(let e=0;e<this.fields.length;e++)t[String(this.fields[e].id)]=e;for(let o=0,s=e.lead.length;o<s;o++)void 0===t[e.lead[o]]&&l("data.pivot - pivot keep column '"+e.lead[o]+"' not found");for(let o=0,s=e.cols.length;o<s;o++)e.cols&&void 0===t[e.cols[o]]&&l("data.pivot - pivot columns source column '"+e.cols[o]+"' not found");for(let o=0,s=e.keep.length;o<s;o++)void 0===t[e.keep[o]]&&l("data.pivot - pivot keep column '"+e.keep[o]+"' not found");for(let o=0,s=e.sum.length;o<s;o++)void 0===t[e.sum[o]]&&l("data.pivot - pivot sum column '"+e.sum[o]+"' not found");for(let o=0,s=e.value.length;o<s;o++)void 0===t[e.value[o]]&&l("data.pivot - pivot value column '"+e.value[o]+"' not found");let o=[],r=[],i=this.records;if(e.forced)for(let t=0;t<e.forced.length;t++)r[String(e.forced[t])]=0;for(let s=0,n=i.length;s<n;s++){const n=[i[s][t[e.lead[0]]]];for(let o=1;o<e.lead.length;o++)n.push(i[s][t[e.lead[o]]]);const l=n.join("|");let a=String(i[s][t[e.cols[0]]]),c=null;if("string"==e.calc)c=i[s][t[e.value[0]]];else if(c=1,e.value&&e.value.length){c=0;for(let o=0;o<e.value.length;o++)c+=e.value[o]?__scanValue(i[s][t[e.value[o]]]):1}if((!a||a.length<1)&&(a="undefined"),void 0===r[a]&&(r[a]=0),o[l]){for(let r=0;r<e.keep.length;r++)i[s][t[e.keep[r]]]&&i[s][t[e.keep[r]]].length&&o[l][e.keep[r]]!=i[s][t[e.keep[r]]]&&(o[l][e.keep[r]]=i[s][t[e.keep[r]]]);for(let r=0;r<e.sum.length;r++)o[l][e.sum[r]]+=Number(i[s][t[e.sum[r]]])}else{o[l]={Total:0};for(let r=0;r<e.keep.length;r++)o[l][e.keep[r]]=i[s][t[e.keep[r]]];for(let r=0;r<e.sum.length;r++)o[l][e.sum[r]]=Number(i[s][t[e.sum[r]]])}o[l].Total+=c,o[l][a]?(e.calc,"max"==e.calc?o[l][a]=Math.max(c,o[l][a]):(o[l][a]+=c,o[l][a+"count"]++)):(o[l][a]=c,o[l][a+"count"]=1)}this.__pivot=new n.Table;for(let t=0;t<e.lead.length;t++)this.__pivot.fields.push({id:e.lead[t]});for(let t=0;t<e.keep.length;t++)this.__pivot.fields.push({id:e.keep[t]});for(let t=0;t<e.sum.length;t++)this.__pivot.fields.push({id:e.sum[t]});if(e.cols&&e.cols.length)for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&this.__pivot.fields.push({id:e});this.__pivot.fields.push({id:"Total"});for(let t in o)if(Object.prototype.hasOwnProperty.call(o,t)){const s=[],n=t.split("|");if(e.lead&&e.lead.length)for(let e=0;e<n.length;e++)s.push(n[e]);for(let r=0;r<e.keep.length;r++)s.push(o[t][e.keep[r]]);for(let r=0;r<e.sum.length;r++)s.push(o[t][e.sum[r]]);if(e.cols&&e.cols.length)for(let n in r)Object.prototype.hasOwnProperty.call(r,n)&&("mean"==e.calc?s.push((o[t][n]||0)/(o[t][n+"count"]||1)):s.push(o[t][n]||0));s.push(o[t].Total),this.__pivot.records.push(s),this.__pivot.table.records++}return this.__pivot},subtable:function(e){if(this.__subt=new n.Table,e.fields){e.columns=[];for(let t=0;t<e.fields.length;t++)for(let o=0;o<this.fields.length;o++)this.fields[o].id==e.fields[t]&&e.columns.push(o)}for(let t=0;t<e.columns.length;t++)this.__subt.fields.push({id:String(this.fields[e.columns[t]].id)}),this.__subt.table.fields++;for(const t in this.records){let o=[];for(let s=0;s<e.columns.length;s++)o.push(this.records[t][e.columns[s]]);this.__subt.records.push(o),this.__subt.table.records++}return this.__subt},sort:function(e,t){let o=this.column(e).values(),s=0;for(let e=0;e<Math.min(o.length,10);e++)isNaN(parseFloat(String(o[e]).replace(",",".")))||s++;let r=[];if(s)for(let e=0;e<o.length;e++)r.push({index:e,value:Number(String(o[e]).replace(",","."))});else for(let e=0;e<o.length;e++)r.push({index:e,value:o[e]});t&&"DOWN"==t?r.sort((function(e,t){return e.value>t.value?-1:1})):r.sort((function(e,t){return e.value<t.value?-1:1}));let n=[];for(let e=0;e<r.length;e++)n.push(this.records[r[e].index]);return this.records=n,this},append:function(e){if(this.table.fields.length!=e.table.fields.length)return null;for(let t=0;t<this.table.fields.length;t++)if(this.table.fields[t].id!=e.table.fields[t].id)return null;let t=e.records;for(let e=0;e<t.length;e++)this.records.push(t[e]);return this.table.records=this.records.length,this},json:function(){this.__json=[];for(const e in this.records){let t={};for(const o in this.fields)t[String(this.fields[o].id)]=this.records[e][o];this.__json.push(t)}return this.__json}},__myNumber=function(e){let t=parseFloat(e.replace(/\./g,"").replace(/\,/g,"."));return isNaN(t)?0:t},__scanValue=function(e){let t=null;return String(e).match(/,/)?(t=parseFloat(String(e).replace(/\./gi,"").replace(/,/gi,".")),isNaN(t)?0:t):(t=parseFloat(String(e).replace(/ /gi,"")),isNaN(t)?0:t)},n.Table.prototype.addTimeColumns=function(e){if(!e.source)return null;for(const t in this.fields)if(this.fields[t].id==e.source){let o=e.create||["date","year","month","day","hour"];for(let e=0;e<o.length;e++)this.fields.push({id:String(o[e])}),this.table.fields++;let s=this.records.length,r=0;for(r=0;r<s;r++){let e=new Date(this.records[r][t]);if(e)for(let t=0;t<o.length;t++)switch(o[t]){case"date":let t=String(e.getDate())+"."+String(e.getMonth()+1)+"."+String(e.getFullYear());this.records[r].push(t);break;case"year":this.records[r].push(e.getFullYear());break;case"month":this.records[r].push(e.getMonth()+1);break;case"day":this.records[r].push(e.getDay());break;case"hour":this.records[r].push(e.getHours());break}}}return this},n.Column=function(){this.table=null,this.index=null,this.valueA=null},n.Column.prototype={values:function(){this.valueA=[];for(const e in this.table.records)this.valueA.push(this.table.records[e][this.index]);return this.valueA},uniqueValues:function(){this.valueA=[];for(const e in this.table.records)this.valueA.push(this.table.records[e][this.index]);return this.valueA.filter(r)},map:function(e){for(const t in this.table.records)this.table.records[t][this.index]=e(this.table.records[t][this.index],this.table.records[t],this.index);return this},rename:function(e){return this.table.fields[this.index].id=e,this},remove:function(){this.table.fields.splice(this.index,1);for(const e in this.table.records)this.table.records[e].splice(this.index,1);return this.table.table.fields--,this}},n.Feed.prototype.column=function(e){return this.dbtable.column(e)},n.Feed.prototype.select=function(e){return this.dbtable.select(e)},n.Feed.prototype.aggregate=function(e,t){return this.dbtable.aggregate(e,t)},n.Feed.prototype.revert=function(){return this.dbtable.revert()},n.Feed.prototype.reverse=function(){return this.dbtable.reverse()},n.Feed.prototype.pivot=function(e){return this.dbtable.pivot(e)},n.Feed.prototype.subtable=function(e){return this.dbtable.subtable(e)},n.Feed.prototype.addTimeColumns=function(e){return this.dbtable.addTimeColumns(e)},n.Broker=function(e){this.souceQueryA=[],this.options=e||{},e&&this.parseDefinition(e),this.onNotify=function(){},this.onError=function(e){alert("error loading data:"+e)}},n.Broker.prototype=new n.Feed,n.Broker.prototype={addSource:function(e,t){return _LOG("Data.Broker.addSource: "+e),this.souceQueryA.push({url:e,type:t,data:null,result:null,next:this}),this},setCallback:function(e){return this.callback=e,this},realize:function(e){this.callback=e||this.callback;for(const e in this.souceQueryA)if(this.souceQueryA[e].url&&!this.souceQueryA[e].result)return this.getData(this.souceQueryA[e]),this;this.data=[];for(const e in this.souceQueryA)this.data.push(this.souceQueryA[e].data||new n.Table);return this.callback(this.data),this},error:function(e){return this.onError=e||this.onError,this},notify:function(e){return this.onNotify=e||this.onNotify,this}},n.Broker.prototype.parseDefinition=function(e){this.callback=e.callback||null},n.Broker.prototype.getData=function(e){this.onNotify(e),e.feed=n.feed({source:e.url,type:e.type,options:e.next.options,parent:this}).load((function(t){e.data=t,e.data.raw=e.feed.data,this.parent.onNotify(e),e.result="success",e.next.realize()})).error((function(t){this.parent.onError(e.url),e.data=null,e.result="error",e.next.realize()}))},n.Broker.prototype.setData=function(e){this.parent.__doCreateTableDataObject(e,null,this.parent.options)},n.Feed.prototype.broker=function(e){let t=new n.Broker(e);return t.parent=this,t},n.broker=function(){return new n.Broker},n.provider=function(){return new n.Broker},n.Merger=function(e){this.sourceA=[],this.options=e||{},e&&this.parseDefinition(e)},n.Merger.prototype={addSource:function(e,t){return this.sourceA.push({data:e,opt:t}),this},setOutputColumns:function(e){return this.outColumnsA=e,this},realize:function(e){this.callback=e||this.callback,_LOG("DataMerger: >>>");let t=[];for(const e in this.sourceA){let o=this.sourceA[e];o.opt.columns=o.opt.columns||o.data.columnNames(),o.opt.label=o.opt.label||[],o.opt.columns=s(o.opt.columns),o.opt.label=s(o.opt.label),this.sourceA[e].data||l("DataMerger: source '"+e+"' not found"),this.sourceA[e].data[0]||(this.sourceA[e].data=this.sourceA[e].data.getArray()),this.sourceA[e].data[0]||l("DataMerger: source '"+e+"' not found or not of type Array");let r=[];for(const t in this.sourceA[e].data[0]){this.sourceA[e].data[0][t]==this.sourceA[e].opt.lookup&&(r[this.sourceA[e].opt.lookup]=t);for(const o in this.sourceA[e].opt.columns)this.sourceA[e].opt.label[o]||(this.sourceA[e].opt.label[o]=this.sourceA[e].opt.columns[o]+"."+(Number(e)+1)),this.sourceA[e].data[0][t]==this.sourceA[e].opt.columns[o]&&(r[this.sourceA[e].opt.label[o]]=t)}for(const t in this.sourceA[e].opt.columns)r[this.sourceA[e].opt.label[t]]||_LOG("DataMerger: '"+this.sourceA[e].opt.label[t]+"' not found");t.push(r)}let o=[];for(const e in this.sourceA)for(const t in this.sourceA[e].opt.label)o.push(this.sourceA[e].opt.label[t]);if(!this.outColumnsA){this.outColumnsA=[];for(const e in o)this.outColumnsA.push(o[e])}let r=[];for(const e in this.outColumnsA)for(const o in t)for(const s in t[o])s==this.outColumnsA[e]&&(r[s]={input:o,index:t[o][s]});for(const e in this.outColumnsA)if(!r[this.outColumnsA[e]])for(const t in this.sourceA[0].data[0])this.sourceA[0].data[0][t]==this.outColumnsA[e]&&(r[this.outColumnsA[e]]={input:0,index:t});this.namedSourceA=[];for(let e=1;e<this.sourceA.length;e++){this.namedSourceA[e]=[];for(let o=1;o<this.sourceA[e].data.length;o++)this.namedSourceA[e][String(this.sourceA[e].data[o][t[e][this.sourceA[e].opt.lookup]])]=this.sourceA[e].data[o]}let i=[];i.push(this.outColumnsA);for(let e=1;e<this.sourceA[0].data.length;e++){let o=String(this.sourceA[0].data[e][[t[0][this.sourceA[0].opt.lookup]]]),s=[];for(const t in this.outColumnsA){let n=r[this.outColumnsA[t]];if(!n)return l('DataMerger - missing "'+this.outColumnsA[t]+'" in label:[...]'),null;0==n.input?s.push(this.sourceA[0].data[e][n.index]):this.namedSourceA[n.input][o]?s.push(this.namedSourceA[n.input][o][n.index]):s.push(" ")}i.push(s)}_LOG("DataMerger: done");let a=new n.Table;return a.setArray(i),this.callback&&this.callback(a),a},error:function(e){return this.onError=e||this.onError,this}},n.merger=function(){return new n.Merger};var l=function(e){}}(window,document);